
import { expect } from 'chai';
import 'mocha';
import { PackageParser } from '../app/class/packageParser';
import { Package } from '../app/class/package';
import { Dependency } from '../app/class/dependency';
import { AlternativeDependency } from '../app/class/alternativeDependency';

const emptyArray = (array: any[]) => array.length = 0;

describe('Package parser mock status file tests', () => {

    let packages: Package[] = []

    beforeEach(async () => {
        packages = PackageParser.fromStatusFile("tests/mockStatusFile");
    })

    afterEach(() => {
        emptyArray(packages)
    });

    it('Non existing file should throw error', () => {
        expect(() => {
            PackageParser.fromStatusFile("doesnotexist");
        }).to.throw(`Error: ENOENT: no such file or directory, open 'doesnotexist'`);
    });

    it('Empty file should throw an error', () => {
        expect(() => {
            PackageParser.fromStatusFile("tests/emptyMockFile");
        }).to.throw(`Error: File is empty`);
    });

    it('Length of packages array should equal 8', () => {
        expect(packages.length).to.equal(8);
    });

    it(`Package 'python' should have correct dependencies`, () => {
        const pythonPackage: Package | undefined = packages.find((_package) => _package.packageName === 'python')
        expect(pythonPackage).not.to.be.undefined;
        if (pythonPackage) {
            expect(pythonPackage.dependencies.length).to.equal(2, 'package python did not have two dependencies');
            const pythonTwoPointSevenDependency: Dependency | undefined = pythonPackage.dependencies.find((dependency: Dependency) => dependency.packageName === 'python2.7');
            const pythonMinimalDependency: Dependency | undefined = pythonPackage.dependencies.find((dependency: Dependency) => dependency.packageName === 'python-minimal');
            expect(pythonTwoPointSevenDependency).not.to.be.undefined;
            expect(pythonMinimalDependency).not.to.be.undefined;
        }
    });

    it(`Package 'libgdbm3' should have correct dependencies`, () => {
        const libgdbm3: Package | undefined = packages.find((_package) => _package.packageName === 'libgdbm3')
        expect(libgdbm3).not.to.be.undefined;
        if (libgdbm3) {
            expect(libgdbm3.dependencies.length).to.equal(2, 'package libc6 did not have two dependencies');
            const lib6: Dependency | undefined = libgdbm3.dependencies.find((dependency: Dependency) => dependency.packageName === 'libc6');
            const dpkg: Dependency | undefined = libgdbm3.dependencies.find((dependency: Dependency) => dependency.packageName === 'dpkg');
            expect(lib6).not.to.be.undefined;
            expect(dpkg).not.to.be.undefined;
            if (dpkg) {
                const installInfo: AlternativeDependency | undefined = dpkg.alternatives.find((dependency) => dependency.packageName === 'install-info')
                expect(installInfo).not.to.be.undefined;
                if (installInfo) {
                    expect(installInfo.isInstalled).to.be.true;
                }
            }
        }
    });

    it(`should provide correct JSON`, async () => {
        const json = JSON.stringify(packages);
        console.log(json)
        const expectedJson = `[{"packageName":"install-info","source":"texinfo","version":"4.13a.dfsg.1-8ubuntu2","section":"doc","priority":"important","architecture":"amd64","dependencies":[{"packageName":"libc6","isInstalled":false,"alternatives":[]}],"preDependencies":[],"installedSize":218,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","description":{"synopsis":"Manage installed documentation in info format","longDescription":"The install-info utility creates the index of all installed documentation\\n in info format and makes it available to info readers."},"status":"install ok installed","multiArch":"foreign","dependingPackageNames":["libgdbm3"],"replaces":"texinfo (<< 4.13a.dfsg.1-2)","breaks":"texinfo (<< 4.13a.dfsg.1-2)","originalMaintainer":"Debian TeX maintainers <debian-tex-maint@lists.debian.org>","extraFields":[]},{"packageName":"libbsf-java","version":"1:2.4.0-5","section":"java","priority":"optional","architecture":"all","dependencies":[{"packageName":"libapache-pom-java","isInstalled":false,"alternatives":[]}],"suggests":"bsh, libxalan2-java, rhino","preDependencies":[],"installedSize":130,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","homePage":"http://jakarta.apache.org/bsf/","description":{"synopsis":"Bean Scripting Framework to support scripting languages in Java","longDescription":"Bean Scripting Framework (BSF) is a set of Java classes which provides\\n scripting language support within Java applications, and access to Java\\n objects and methods from scripting languages. BSF allows one to write JSPs in\\n languages other than Java while providing access to the Java class library. In\\n addition, BSF permits any Java application to be implemented in part (or\\n dynamically extended) by a language that is embedded within it. This is\\n achieved by providing an API that permits calling scripting language engines\\n from within Java, as well as an object registry that exposes Java objects to\\n these scripting language engines.\\n .\\n BSF supports these scripting languages:\\n  * Python (using Jython)\\n  * JavaScript (using rhino)\\n  * XSLT Stylesheets (as a component of Apache XML project's Xalan and Xerces)\\n  * BeanShell (using bsh) via its own bsf adapter\\n .\\n Support for Tcl, NetRexx is not available in this Debian\\n package since Jacl, NetRexx (non-free) are not packaged."},"status":"install ok installed","dependingPackageNames":[],"originalMaintainer":"Debian Java Maintainers <pkg-java-maintainers@lists.alioth.debian.org>","extraFields":[]},{"packageName":"libgdbm3","source":"gdbm","version":"1.8.3-10","section":"libs","priority":"important","architecture":"amd64","dependencies":[{"packageName":"libc6","isInstalled":false,"alternatives":[]},{"packageName":"dpkg","isInstalled":false,"alternatives":[{"packageName":"install-info","isInstalled":true}]}],"preDependencies":[{"packageName":"multiarch-support","isInstalled":false,"alternatives":[]}],"installedSize":132,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","homePage":"http://directory.fsf.org/project/gdbm/","description":{"synopsis":"GNU dbm database routines (runtime version)","longDescription":"GNU dbm ('gdbm') is a library of database functions that use extendible\\n hashing and works similarly to the standard UNIX 'dbm' functions.\\n .\\n The basic use of 'gdbm' is to store key/data pairs in a data file, thus\\n providing a persistent version of the 'dictionary' Abstract Data Type\\n ('hash' to perl programmers)."},"status":"install ok installed","multiArch":"same","dependingPackageNames":[],"originalMaintainer":"Anibal Monsalve Salazar <anibal@debian.org>","extraFields":[]},{"packageName":"openssh-client","source":"openssh","version":"1:5.9p1-5ubuntu1","section":"net","priority":"standard","architecture":"amd64","dependencies":[{"packageName":"libc6","isInstalled":false,"alternatives":[]},{"packageName":"libedit2","isInstalled":false,"alternatives":[]},{"packageName":"libgssapi-krb5-2","isInstalled":false,"alternatives":[]},{"packageName":"libselinux1","isInstalled":false,"alternatives":[]},{"packageName":"libssl1.0.0","isInstalled":false,"alternatives":[]},{"packageName":"zlib1g","isInstalled":false,"alternatives":[]},{"packageName":"debconf","isInstalled":false,"alternatives":[{"packageName":"debconf-2.0","isInstalled":false}]},{"packageName":"adduser","isInstalled":false,"alternatives":[]},{"packageName":"dpkg","isInstalled":false,"alternatives":[]},{"packageName":"passwd","isInstalled":false,"alternatives":[]}],"recommends":"xauth","suggests":"ssh-askpass, libpam-ssh, keychain, monkeysphere, openssh-blacklist, openssh-blacklist-extra","preDependencies":[],"installedSize":2278,"maintainer":"Colin Watson <cjwatson@ubuntu.com>","homePage":"http://www.openssh.org/","description":{"synopsis":"secure shell (SSH) client, for secure access to remote machines","longDescription":"This is the portable version of OpenSSH, a free implementation of\\n the Secure Shell protocol as specified by the IETF secsh working\\n group.\\n .\\n Ssh (Secure Shell) is a program for logging into a remote machine\\n and for executing commands on a remote machine.\\n It provides secure encrypted communications between two untrusted\\n hosts over an insecure network. X11 connections and arbitrary TCP/IP\\n ports can also be forwarded over the secure channel.\\n It can be used to provide applications with a secure communication\\n channel.\\n .\\n This package provides the ssh, scp and sftp clients, the ssh-agent\\n and ssh-add programs to make public key authentication more convenient,\\n and the ssh-keygen, ssh-keyscan, ssh-copy-id and ssh-argv0 utilities.\\n .\\n In some countries it may be illegal to use any encryption at all\\n without a special permit.\\n .\\n ssh replaces the insecure rsh, rcp and rlogin programs, which are\\n obsolete for most purposes."},"status":"install ok installed","multiArch":"foreign","dependingPackageNames":["openssh-server"],"replaces":"ssh, ssh-krb5","provides":"rsh-client, ssh-client","conflicts":"rsh-client (<< 0.16.1-1), sftp, ssh (<< 1:3.8.1p1-9), ssh-krb5 (<< 1:4.3p2-7)","originalMaintainer":"Debian OpenSSH Maintainers <debian-ssh@lists.debian.org>","extraFields":[{"fieldName":"Conffiles:\\n /etc/ssh/ssh_config a7a6e6ef00bcd077b9b5e3e1b744fd30\\n /etc/ssh/moduli b1c007bf229d5d1707a2aebe9732f13c"}]},{"packageName":"openssh-server","source":"openssh","version":"1:5.9p1-5ubuntu1","section":"net","priority":"optional","architecture":"amd64","dependencies":[{"packageName":"libc6","isInstalled":false,"alternatives":[]},{"packageName":"libcomerr2","isInstalled":false,"alternatives":[]},{"packageName":"libgssapi-krb5-2","isInstalled":false,"alternatives":[]},{"packageName":"libkrb5-3","isInstalled":false,"alternatives":[]},{"packageName":"libpam0g","isInstalled":false,"alternatives":[]},{"packageName":"libselinux1","isInstalled":false,"alternatives":[]},{"packageName":"libssl1.0.0","isInstalled":false,"alternatives":[]},{"packageName":"libwrap0","isInstalled":false,"alternatives":[]},{"packageName":"zlib1g","isInstalled":false,"alternatives":[]},{"packageName":"debconf","isInstalled":false,"alternatives":[{"packageName":"debconf-2.0","isInstalled":false}]},{"packageName":"openssh-client","isInstalled":true,"alternatives":[]},{"packageName":"upstart-job","isInstalled":false,"alternatives":[]},{"packageName":"libpam-runtime","isInstalled":false,"alternatives":[]},{"packageName":"libpam-modules","isInstalled":false,"alternatives":[]},{"packageName":"adduser","isInstalled":false,"alternatives":[]},{"packageName":"dpkg","isInstalled":false,"alternatives":[]},{"packageName":"lsb-base","isInstalled":false,"alternatives":[]},{"packageName":"procps","isInstalled":false,"alternatives":[]}],"recommends":"xauth, ssh-import-id","suggests":"ssh-askpass, rssh, molly-guard, openssh-blacklist, openssh-blacklist-extra, ufw, monkeysphere","preDependencies":[],"installedSize":807,"maintainer":"Colin Watson <cjwatson@ubuntu.com>","homePage":"http://www.openssh.org/","description":{"synopsis":"secure shell (SSH) server, for secure access from remote machines","longDescription":"This is the portable version of OpenSSH, a free implementation of\\n the Secure Shell protocol as specified by the IETF secsh working\\n group.\\n .\\n Ssh (Secure Shell) is a program for logging into a remote machine\\n and for executing commands on a remote machine.\\n It provides secure encrypted communications between two untrusted\\n hosts over an insecure network. X11 connections and arbitrary TCP/IP\\n ports can also be forwarded over the secure channel.\\n It can be used to provide applications with a secure communication\\n channel.\\n .\\n This package provides the sshd server.\\n .\\n In some countries it may be illegal to use any encryption at all\\n without a special permit.\\n .\\n sshd replaces the insecure rshd program, which is obsolete for most\\n purposes."},"status":"install ok installed","multiArch":"foreign","dependingPackageNames":[],"replaces":"openssh-client (<< 1:3.8.1p1-11), ssh, ssh-krb5","provides":"ssh-server","conflicts":"rsh-client (<< 0.16.1-1), sftp, ssh (<< 1:3.8.1p1-9), ssh-krb5 (<< 1:4.3p2-7), ssh-nonfree (<< 2), ssh-socks, ssh2","originalMaintainer":"Debian OpenSSH Maintainers <debian-ssh@lists.debian.org>","extraFields":[{"fieldName":"Conffiles:\\n /etc/network/if-up.d/openssh-server d6e8fb0f6192bc4cb91c4a1bc50d096b\\n /etc/default/ssh 500e3cf069fe9a7b9936108eb9d9c035\\n /etc/pam.d/sshd 5ad89e19556206e750f3b096fbe9c6b3\\n /etc/init/ssh.conf 2c7eae0c0ef56b191dad89310fa36b8e\\n /etc/ufw/applications.d/openssh-server 486b78d54b93cc9fdc950c1d52ff479e\\n /etc/init.d/ssh 72f87136ef9b97c7dba5fe2b75e13a59"}]},{"packageName":"python","source":"python-defaults","version":"2.7.3-0ubuntu2","section":"python","priority":"important","architecture":"amd64","dependencies":[{"packageName":"python2.7","isInstalled":false,"alternatives":[]},{"packageName":"python-minimal","isInstalled":false,"alternatives":[]}],"suggests":"python-doc (= 2.7.3-0ubuntu2), python-tk (= 2.7.3-0ubuntu2)","preDependencies":[],"installedSize":658,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","homePage":"http://www.python.org/","description":{"synopsis":"interactive high-level object-oriented language (default version)","longDescription":"Python, the high-level, interactive object oriented language,\\n includes an extensive class library with lots of goodies for\\n network programming, system administration, sounds and graphics.\\n .\\n This package is a dependency package, which depends on Debian's default\\n Python version (currently v2.7)."},"status":"install ok installed","dependingPackageNames":["python-pkg-resources"],"replaces":"python-dev (<< 2.6.5-2)","provides":"python-ctypes, python-email, python-importlib, python-profiler, python-wsgiref","conflicts":"python-central (<< 0.5.5)","breaks":"python-bz2 (<< 1.1-8), python-csv (<< 1.0-4), python-email (<< 2.5.5-3), update-manager-core (<< 0.200.5-2)","originalMaintainer":"Matthias Klose <doko@debian.org>","extraFields":[]},{"packageName":"python-pkg-resources","source":"distribute","version":"0.6.24-1ubuntu1","section":"python","priority":"optional","architecture":"all","dependencies":[{"packageName":"python","isInstalled":true,"alternatives":[]}],"suggests":"python-distribute, python-distribute-doc","preDependencies":[],"installedSize":175,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","homePage":"http://packages.python.org/distribute","description":{"synopsis":"Package Discovery and Resource Access using pkg_resources","longDescription":"The pkg_resources module provides an API for Python libraries to\\n access their resource files, and for extensible applications and\\n frameworks to automatically discover plugins.  It also provides\\n runtime support for using C extensions that are inside zipfile-format\\n eggs, support for merging packages that have separately-distributed\\n modules or subpackages, and APIs for managing Python's current\\n \\"working set\\" of active packages."},"status":"install ok installed","dependingPackageNames":[],"replaces":"python2.3-setuptools, python2.4-setuptools","provides":"python2.6-setuptools, python2.7-setuptools","conflicts":"python-setuptools (<< 0.6c8-3), python2.3-setuptools (<< 0.6b2), python2.4-setuptools (<< 0.6b2)","originalMaintainer":"Matthias Klose <doko@debian.org>","extraFields":[{"fieldName":"Python-Version","value":"2.6, 2.7"}]},{"packageName":"tcpd","source":"tcp-wrappers","version":"7.6.q-21","section":"net","priority":"optional","architecture":"amd64","dependencies":[{"packageName":"libc6","isInstalled":false,"alternatives":[]},{"packageName":"libwrap0","isInstalled":false,"alternatives":[]}],"preDependencies":[],"installedSize":132,"maintainer":"Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>","description":{"synopsis":"Wietse Venema's TCP wrapper utilities","longDescription":"Wietse Venema's network logger, also known as TCPD or LOG_TCP.\\n .\\n These programs log the client host name of incoming telnet,\\n ftp, rsh, rlogin, finger etc. requests.\\n .\\n Security options are:\\n  - access control per host, domain and/or service;\\n  - detection of host name spoofing or host address spoofing;\\n  - booby traps to implement an early-warning system."},"status":"install ok installed","multiArch":"foreign","dependingPackageNames":[],"replaces":"libwrap0 (<< 7.6-8)","originalMaintainer":"Marco d'Itri <md@linux.it>","extraFields":[]}]`
        expect(json).to.equal(expectedJson);
    });


});